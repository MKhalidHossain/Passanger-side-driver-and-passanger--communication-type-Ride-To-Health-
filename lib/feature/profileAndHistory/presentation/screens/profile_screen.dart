import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:rideztohealth/core/extensions/text_extensions.dart';
import 'package:rideztohealth/feature/auth/controllers/auth_controller.dart';
import 'package:rideztohealth/feature/profileAndHistory/controllers/profile_and_history_controller.dart';
import 'package:rideztohealth/feature/profileAndHistory/presentation/screens/account_security_screen.dart';
import 'package:rideztohealth/feature/profileAndHistory/presentation/screens/edit_profile_screen.dart';
import 'package:rideztohealth/feature/profileAndHistory/presentation/screens/notifications_screen.dart';
import 'package:rideztohealth/feature/profileAndHistory/presentation/screens/terms_and_condition.dart';
import 'package:rideztohealth/feature/profileAndHistory/presentation/screens/wallet_screen.dart';
import 'package:shimmer/shimmer.dart';
import '../../../../core/constants/app_colors.dart';

class ProfileScreen extends StatefulWidget {
  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  AuthController authController = Get.find<AuthController>();
  ProfileAndHistoryController profileController = Get.find<ProfileAndHistoryController>();

  @override
  void initState() {
    profileController.getProfile();
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: GetBuilder<ProfileAndHistoryController>(
        builder: (controller) {
          return Scaffold(
            body: controller.isLoading
                ? _buildProfileShimmer(context)
                : _buildProfileContent(context, controller),
          );
        },
      ),
    );
  }

  /// ðŸ”¹ When data is loading, show shimmer placeholders for each section
  Widget _buildProfileShimmer(BuildContext context) {
    final baseColor = Colors.grey.shade300;
    final highlightColor = Colors.grey.shade100;

    return Shimmer.fromColors(
      baseColor: baseColor,
      highlightColor: highlightColor,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const SizedBox(height: 16),
          Center(
            child: Container(height: 24, width: 150, color: Colors.white10),
          ),
          const SizedBox(height: 16),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                Container(
                  height: 80,
                  width: 80,
                  decoration: BoxDecoration(
                    color: Colors.white10,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(height: 20, width: 120, color: Colors.white10),
                    const SizedBox(height: 8),
                    Container(height: 16, width: 180, color: Colors.white10),
                  ],
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: ListView.separated(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              itemCount: 6,
              separatorBuilder: (_, __) => const SizedBox(height: 8),
              itemBuilder: (_, __) => Container(
                height: 65,
                decoration: BoxDecoration(
                  color: Colors.white10,
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// ðŸ”¹ Actual profile content after loading completes
  Widget _buildProfileContent(
    BuildContext context,
    ProfileAndHistoryController controller,
  ) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Center(
          child: Padding(
            padding: const EdgeInsets.only(top: 16),
            child: 'My Profile'.text20white(),
          ),
        ),
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: Colors.white10,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Container(
                  height: 80,
                  width: 80,
                  padding: const EdgeInsets.all(3),
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    gradient: LinearGradient(
                      colors: [
                        const Color(0xffCE0000).withOpacity(0.8),
                        const Color(0xff7B0100).withOpacity(0.8),
                      ],
                    ),
                  ),
                  child: ClipOval(
                    child: Builder(
                      builder: (context) {
                        final imageUrl = controller
                            .getProfileResponseModel
                            .data
                            ?.profileImage;
                        if (imageUrl == null || imageUrl.isEmpty) {
                          return Center(
                            child: Icon(
                              Icons.person_outline,
                              size: 30,
                              color: Colors.grey,
                            ),
                          );
                        }
                        return Image.network(
                          imageUrl,
                          fit: BoxFit.cover,
                          loadingBuilder: (context, child, loadingProgress) {
                            if (loadingProgress == null) return child;
                            return Shimmer.fromColors(
                              baseColor: Colors.grey.shade300,
                              highlightColor: Colors.grey.shade100,
                              child: Container(color: Colors.white),
                            );
                          },
                          errorBuilder: (context, error, stackTrace) {
                            return const Center(
                              child: Icon(
                                Icons.person_outline,
                                size: 30,
                                color: Colors.grey,
                              ),
                            );
                          },
                        );
                      },
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    controller.getProfileResponseModel.data?.fullName ?? '',
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 20,
                      fontFamily: 'outfit',
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
        Expanded(
          child: Padding(
            padding: const EdgeInsets.all(16.0),
            child: ListView(
              children: [
                _buildMenuItem(
                  Icons.person_outline,
                  "Profile",
                  "Customize your profile",
                  onTap: () {
                    Get.to(
                      () => EditProfile(
                        userProfile: controller.getProfileResponseModel.data,
                      ),
                    );
                  },
                ),
                _divider(),
                // _buildMenuItem(
                //   Icons.wallet_outlined,
                //   "Wallet",
                //   "Term of services",
                //   onTap: () {
                //     Get.to(() => WalletScreen());
                //   },
                // ),
                _divider(),
                _buildMenuItem(
                  Icons.notifications_outlined,
                  "Manage Notifications",
                  "Customize alerts",
                  onTap: () {
                    Get.to(() => NotificationsScreen());
                  },
                ),
                _divider(),
                _buildMenuItem(
                  Icons.lock_outline,
                  "Account Security",
                  "Change your password",
                  onTap: () {
                    Get.to(() => const AccountSecurityScreen());
                  },
                ),
                _divider(),
                _buildMenuItem(
                  Icons.help_outline,
                  "Terms & Conditions",
                  "Terms & Services",
                  onTap: () {
                    Get.to(() => TermsAndCondition());
                  },
                ),
                _divider(),
                _buildMenuItem(
                  Icons.shield_outlined,
                  "Privacy Policy",
                  "Privacy policy",
                  onTap: () {},
                ),
                _divider(),
                _buildMenuItem(
                  Icons.logout,
                  "Log Out",
                  "Sign out of your account",
                  color: const Color(0xffCE0000).withOpacity(0.8),
                  onTap: () async {
                    await Get.find<AuthController>().logOut();
                  },
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildMenuItem(
    IconData icon,
    String title,
    String subtitle, {
    Color color = Colors.black54,
    required VoidCallback onTap,
  }) {
    return Container(
      color: Colors.white10,
      margin: const EdgeInsets.all(1),
      child: ListTile(
        leading: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: const Color(0xffD8D8D8),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: color),
        ),
        title: Text(
          title,
          style: TextStyle(
            color: color == const Color(0xffCE0000).withOpacity(0.8)
                ? const Color(0xffCE0000).withOpacity(0.8)
                : Colors.white,
            fontSize: 16,
            fontFamily: 'outfit',
            fontWeight: FontWeight.bold,
          ),
        ),
        subtitle: subtitle.text12White(),
        trailing: Icon(
          Icons.arrow_forward_ios,
          size: 16,
          color: AppColors.context(context).iconColor,
        ),
        onTap: onTap,
      ),
    );
  }

  Widget _divider({Color color = const Color(0xffD8D8D8)}) {
    return Divider(
      height: 1,
      indent: 5,
      endIndent: 5,
      thickness: 0.1,
      color: color,
    );
  }
}

// import 'package:flutter/material.dart';
// import 'package:rideztohealth/core/extensions/text_extensions.dart';

// class ProfileScreen extends StatefulWidget {
//   @override
//   State<ProfileScreen> createState() => _ProfileScreenState();
// }

// class _ProfileScreenState extends State<ProfileScreen> {
//   @override
//   void initState() {
//     //Get.find<ProfileController>().getUserById();
//     super.initState();
//   }

//   @override
//   Widget build(BuildContext context) {
//     Size size = MediaQuery.of(context).size;
//     // final String today = DateFormat('d MMMM').format(DateTime.now());

//     //     if (profileController
//     //         .getUserByIdResponseModel
//     //         .userforProfile
//     //         .isBlank!) {
//     //       print('task is empty');
//     //       return Container(
//     //         height: size.height * 0.8,
//     //         width: size.width,
//     //         child: const Center(child: Text('No Task Found')),
//     //       );
//     //     }
//     //     if (profileController.getUserByIdResponseModel == null) {
//     //       print('TAsk is null');
//     //       return Container(
//     //         height: size.height * 0.8,
//     //         width: size.width,
//     //         child: const Center(child: Text('No Task Found')),
//     //       );
//     //     }
//     // return !profileController.getUserByIdisLoading
//     //     ?

//     return ColoredBox(
//       color: Color(0xFF438B92),
//       child: SafeArea(
//         child: Scaffold(
//           //backgroundColor: Color(0xffB0E0CF), // light gray-blue background
//           body: Column(
//             crossAxisAlignment: CrossAxisAlignment.start,
//             children: [
//               // App bar title
//               Center(
//                 child: Padding(
//                   padding: const EdgeInsets.only(top: 16),
//                   child: 'My Profile'.text20Black(),
//                 ),
//               ),

//               // Profile Section
//               Padding(
//                 padding: const EdgeInsets.all(16.0),
//                 child: Row(
//                   children: [
//                     CircleAvatar(
//                       radius: 30,
//                       backgroundColor: Colors.grey[200],
//                       child: ClipOval(
//                         child: Image.network(
//                           // profileController
//                           //         .getUserByIdResponseModel
//                           //         .userforProfile
//                           //         ?.avatar ??
//                           '',
//                           width: 60,
//                           height: 60,
//                           fit: BoxFit.cover,
//                           errorBuilder: (context, error, stackTrace) {
//                             return Center(
//                               child: Icon(
//                                 Icons.person_outline,
//                                 size: 30,
//                                 color: Colors.grey,
//                               ),
//                             );
//                           },
//                         ),
//                       ),
//                     ),
//                     // CircleAvatar(
//                     //   radius: 30,
//                     //   backgroundImage: NetworkImage(
//                     //     profileController
//                     //         .getUserByIdResponseModel
//                     //         .user!
//                     //         .avatar
//                     //         .toString(),
//                     //   ),
//                     //   // AssetImage(
//                     //   //   'assets/images/person.png',
//                     //   // ), // Your profile image
//                     // ),
//                     SizedBox(width: 12),
//                     Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         // (

//                         //   profileController
//                         //         .getUserByIdResponseModel
//                         //         .userforProfile!
//                         //         .name!
//                         //         )
//                         'John Doe'.text22White(),
//                         SizedBox(height: 4),
//                       ],
//                     ),
//                     Spacer(),
//                     // InkWell(
//                     //   onTap: () {
//                     //     // final profileUser =
//                     //     //     profileController
//                     //     //         .getUserByIdResponseModel
//                     //     //         .userforProfile;
//                     //     // if (profileUser != null) {
//                     //     //   Get.to(
//                     //     //     EditProfile(userProfile: profileUser),
//                     //     //   );
//                     //     // } else {
//                     //     //   Get.snackbar(
//                     //     //     'Error',
//                     //     //     'User data not loaded yet',
//                     //     //   );
//                     //     // }
//                     //   },
//                     //   child: Image.asset(
//                     //     'assets/icons/edit.png',
//                     //     height: 70,
//                     //     width: 70,
//                     //   ),
//                     // ),
//                   ],
//                 ),
//               ),

//               Expanded(
//                 child: Padding(
//                   padding: const EdgeInsets.all(8.0),
//                   child: ListView(
//                     children: [
//                       SizedBox(height: 30),
//                       _buildMenuItem(
//                         Icons.info_outline,
//                         "About App",
//                         onTap: () {
//                           //Get.to(AboutAppScreen());
//                         },
//                       ),
//                       _divider(),
//                       _buildMenuItem(
//                         Icons.privacy_tip_outlined,
//                         "Privacy Policy",
//                         onTap: () {
//                           //Get.to(PrivacyPolicyScreen());
//                         },
//                       ),
//                       _divider(),
//                       _buildMenuItem(
//                         Icons.article_outlined,
//                         "Term & Condition",
//                         onTap: () {
//                           //Get.to(TearmAndConditonScreen());
//                         },
//                       ),
//                       _divider(),
//                       _buildMenuItem(
//                         Icons.lock_outline,
//                         "Change Password",
//                         onTap: () {
//                           // Get.to(ChangePasswordScreen());
//                         },
//                       ),
//                       _divider(),
//                       _buildMenuItem(
//                         Icons.notifications_outlined,
//                         "Notification",
//                         onTap: () {
//                           // Get.to(NotificationScreen());
//                         },
//                       ),
//                       _divider(),
//                       _buildMenuItem(
//                         Icons.logout,
//                         "Log Out",
//                         color: Colors.red,
//                         onTap: () {
//                           //Get.to(SignInScreen());
//                         },
//                       ),
//                       _divider(),
//                     ],
//                   ),
//                 ),
//               ),
//             ],
//           ),
//         ),
//       ),
//     );
//     // : Container(child: Center(child: CircularProgressIndicator()));
//   }

//   Widget _buildMenuItem(
//     IconData icon,
//     String title, {
//     Color color = const Color(0xFF438B92),
//     required VoidCallback onTap,

//     //VoidCallback   onTap,
//   }) {
//     return ListTile(
//       leading: Icon(icon, color: color),
//       title: Text(
//         title,
//         style: TextStyle(color: color, fontSize: 16, fontFamily: 'outfit'),
//       ),
//       trailing: Icon(Icons.arrow_forward_ios, size: 16, color: color),
//       onTap: onTap, // Handle navigation here
//     );
//   }

//   Widget _divider({Color color = const Color(0xFF438B92)}) {
//     return Divider(
//       height: 1,
//       indent: 20,
//       endIndent: 20,
//       thickness: 0.5,
//       color: color,
//     );
//   }
// }
